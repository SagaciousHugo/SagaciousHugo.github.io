<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
    
    <entry>
      <title><![CDATA[leetcode 5. Longest Palindromic Substring]]></title>
      <url>http://yoursite.com/2016/06/12/leetcode%205.%20Longest%20Palindromic%20Substring/</url>
      <content type="html"><![CDATA[<ol>
<li>Longest Palindromic Substring<br>Medium</li>
</ol>
<p>Given a string S, find the longest palindromic substring in S. You may assume that the maximum length of S is 1000, and there exists one unique longest palindromic substring.</p>
<a id="more"></a>
<p>题目分析：无</p>
<p>初步思路：无</p>
<p>思路改进：无</p>
<p>最终代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">public class Solution &#123;</span><br><span class="line">  public String longestPalindrome(String s) &#123;</span><br><span class="line">        int substr_start = 0;</span><br><span class="line">        int substr_end = 0;</span><br><span class="line">        int max_length = 0;</span><br><span class="line">        char[] str = s.toCharArray();</span><br><span class="line">        for(int i = 0; i &lt; str.length; i++) &#123;</span><br><span class="line">            for(int j = str.length - 1; j - i + 1 &gt; max_length; j--) &#123;</span><br><span class="line">                if(isPalindrome(str,i,j)) &#123;</span><br><span class="line">                    substr_start = i;</span><br><span class="line">                    substr_end = j;</span><br><span class="line">                    max_length = j - i + 1;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            if(s.length() - i &lt; max_length) &#123;</span><br><span class="line">            	break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return s.substring(substr_start,substr_end +1);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    public boolean isPalindrome(char[] str,int start,int end)&#123;</span><br><span class="line">    	int count = end - start + 1;</span><br><span class="line">        for(int i = 0; i &lt; count ; i++)&#123;</span><br><span class="line">        	if(str[start + i] != str[end - i])&#123;</span><br><span class="line">        		return false;</span><br><span class="line">        	&#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[leetcode 4. Median of Two Sorted Arrays]]></title>
      <url>http://yoursite.com/2016/06/12/leetcode%204.%20Median%20of%20Two%20Sorted%20Arrays/</url>
      <content type="html"><![CDATA[<ol>
<li>Median of Two Sorted Arrays<br>Hard</li>
</ol>
<p>There are two sorted arrays nums1 and nums2 of size m and n respectively. Find the median of the two sorted arrays. The overall run time complexity should be O(log (m+n)).<br><a id="more"></a><br>题目分析：无</p>
<p>初步思路：无</p>
<p>思路改进：无</p>
<p>最终代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">public class Solution &#123;</span><br><span class="line">   public double findMedianSortedArrays(int[] nums1, int[] nums2) &#123;</span><br><span class="line">        int locate = 0;</span><br><span class="line">        double median = 0;</span><br><span class="line">        int m = 0;</span><br><span class="line">        int n = 0;</span><br><span class="line">        int current_number = 0;</span><br><span class="line">        String type = null;</span><br><span class="line">        int length_1 = nums1 != null ? nums1.length : 0 ;</span><br><span class="line">        int length_2 = nums2 != null ? nums2.length : 0 ;</span><br><span class="line">        </span><br><span class="line">        if((length_1 + length_2) % 2 == 0) &#123;</span><br><span class="line">            type = &quot;oven&quot;;</span><br><span class="line">            locate = (length_1 + length_2) / 2;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            type = &quot;odd&quot;; </span><br><span class="line">            locate = (int)((length_1 + length_2) / 2) + 1;</span><br><span class="line">        &#125;</span><br><span class="line">        if(length_1 == 0 &amp;&amp; type.equals(&quot;odd&quot;)) &#123;</span><br><span class="line">            return nums2[locate - 1];</span><br><span class="line">        &#125;</span><br><span class="line">        else if(length_1 == 0 &amp;&amp; type.equals(&quot;oven&quot;)) &#123;</span><br><span class="line">            return (double)(nums2[locate - 1] + nums2[locate]) / 2;</span><br><span class="line">        &#125;</span><br><span class="line">        else if(length_2 == 0 &amp;&amp; type.equals(&quot;odd&quot;)) &#123;</span><br><span class="line">            return nums1[locate - 1];</span><br><span class="line">        &#125;</span><br><span class="line">        else if(length_2 == 0 &amp;&amp; type.equals(&quot;oven&quot;)) &#123;</span><br><span class="line">            return (double)(nums1[locate - 1] + nums1[locate]) / 2;</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">             while(m &lt; length_1 || n &lt; length_2) &#123;</span><br><span class="line">                if(m == length_1) &#123;</span><br><span class="line">                    current_number = nums2[n];</span><br><span class="line">                    n++;</span><br><span class="line">                &#125;</span><br><span class="line">                else if(n == length_2) &#123;</span><br><span class="line">                    current_number = nums1[m];</span><br><span class="line">                    m++;</span><br><span class="line">                &#125;</span><br><span class="line">                else &#123;</span><br><span class="line">                    if(nums1[m] &lt;= nums2[n]) &#123;</span><br><span class="line">                        current_number = nums1[m];</span><br><span class="line">                        m++;</span><br><span class="line">                    &#125;</span><br><span class="line">                    else &#123;</span><br><span class="line">                        current_number = nums2[n];</span><br><span class="line">                        n++;</span><br><span class="line">                    &#125;  </span><br><span class="line">                &#125;</span><br><span class="line">                if(m + n == locate) &#123;</span><br><span class="line">                    median = current_number;</span><br><span class="line">                    if(type.equals(&quot;odd&quot;))&#123;</span><br><span class="line">                        break;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                else if(m + n == locate + 1)&#123;</span><br><span class="line">                    median = (median + current_number) / 2;</span><br><span class="line">                    break;</span><br><span class="line">                &#125; </span><br><span class="line">        &#125;</span><br><span class="line">        return median;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[leetcode 3. Longest Substring Without Repeating Characters]]></title>
      <url>http://yoursite.com/2016/06/12/leetcode%203.%20Longest%20Substring%20Without%20Repeating%20Characters/</url>
      <content type="html"><![CDATA[<ol>
<li>Longest Substring Without Repeating Characters<br>Medium</li>
</ol>
<p>Given a string, find the length of the longest substring without repeating characters.</p>
<p>Examples:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Given &quot;abcabcbb&quot;, the answer is &quot;abc&quot;, which the length is 3.</span><br><span class="line"></span><br><span class="line">Given &quot;bbbbb&quot;, the answer is &quot;b&quot;, with the length of 1.</span><br><span class="line"></span><br><span class="line">Given &quot;pwwkew&quot;, the answer is &quot;wke&quot;, with the length of 3. Note that the answer must be a substring, &quot;pwke&quot; is a subsequence and not a substring.</span><br></pre></td></tr></table></figure></p>
<a id="more"></a>
<p>题目分析：无</p>
<p>初步思路：无</p>
<p>思路改进：无</p>
<p>最终代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public class Solution &#123;</span><br><span class="line">  public int lengthOfLongestSubstring(String s) &#123;</span><br><span class="line">        int max_length = 0;</span><br><span class="line">        int locate_start = 0;</span><br><span class="line">        int[] hashTable = new int[256];</span><br><span class="line">        int[] locateTable = new int[256];</span><br><span class="line">        for(int i = 0; i &lt; s.length();) &#123;</span><br><span class="line">        	if(hashTable[(int)s.charAt(i)] == 0) &#123;</span><br><span class="line">        		if(max_length &lt; i - locate_start + 1) &#123;</span><br><span class="line">            		max_length = i - locate_start + 1;</span><br><span class="line">            	&#125;</span><br><span class="line">            	hashTable[(int)s.charAt(i)]++;</span><br><span class="line">            	locateTable[(int)s.charAt(i)] = i;</span><br><span class="line">            	i++;</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">            	locate_start = locateTable[(int)s.charAt(i)] + 1;</span><br><span class="line">            	i = locate_start;</span><br><span class="line">            	hashTable = new int[256];</span><br><span class="line">                locateTable = new int[256];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return max_length;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[leetcode 2. Add Two Numbers]]></title>
      <url>http://yoursite.com/2016/06/12/leetcode%202.%20Add%20Two%20Numbers/</url>
      <content type="html"><![CDATA[<ol>
<li>Add Two Numbers<br>Medium</li>
</ol>
<p>You are given two linked lists representing two non-negative numbers. The digits are stored in reverse order and each of their nodes contain a single digit. Add the two numbers and return it as a linked list.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Input: (2 -&gt; 4 -&gt; 3) + (5 -&gt; 6 -&gt; 4)</span><br><span class="line">Output: 7 -&gt; 0 -&gt; 8</span><br></pre></td></tr></table></figure></p>
<a id="more"></a>
<p>题目分析：无</p>
<p>初步思路：无</p>
<p>思路改进：无</p>
<p>最终代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * Definition for singly-linked list.</span><br><span class="line"> * public class ListNode &#123;</span><br><span class="line"> *     int val;</span><br><span class="line"> *     ListNode next;</span><br><span class="line"> *     ListNode(int x) &#123; val = x; &#125;</span><br><span class="line"> * &#125;</span><br><span class="line"> */</span><br><span class="line">public class Solution &#123;</span><br><span class="line">    public ListNode addTwoNumbers(ListNode l1, ListNode l2) &#123;</span><br><span class="line">        int carry = 0;</span><br><span class="line">        int index_sum = 0;</span><br><span class="line">        ListNode p = null;</span><br><span class="line">        ListNode tmp = null;</span><br><span class="line">        ListNode tmp1 = l1;</span><br><span class="line">        ListNode tmp2 = l2;</span><br><span class="line">        int val1,val2;</span><br><span class="line">        while(tmp1 != null || tmp2 != null) &#123;</span><br><span class="line">            val1 = tmp1 != null ? tmp1.val : 0;</span><br><span class="line">            val2 = tmp2 != null ? tmp2.val : 0;</span><br><span class="line">            index_sum = val1 + val2 + carry;</span><br><span class="line">            if(index_sum &gt; 9)&#123;</span><br><span class="line">                index_sum = index_sum - 10;</span><br><span class="line">                carry = 1;</span><br><span class="line">            &#125; </span><br><span class="line">            else &#123;</span><br><span class="line">                carry = 0; </span><br><span class="line">            &#125;</span><br><span class="line">            if(p == null) &#123;</span><br><span class="line">                tmp = new ListNode(index_sum);</span><br><span class="line">                p = tmp;</span><br><span class="line">            &#125;</span><br><span class="line">            else &#123;</span><br><span class="line">             tmp.next = new ListNode(index_sum);   </span><br><span class="line">             tmp = tmp.next;</span><br><span class="line">            &#125;</span><br><span class="line">            if(tmp1 != null) &#123;</span><br><span class="line">                tmp1 = tmp1.next;</span><br><span class="line">            &#125;</span><br><span class="line">            if(tmp2 != null) &#123;</span><br><span class="line">                tmp2 = tmp2.next; </span><br><span class="line">            &#125; </span><br><span class="line">        &#125;</span><br><span class="line">        if(carry == 1) &#123;</span><br><span class="line">            tmp.next = new ListNode(1);  </span><br><span class="line">        &#125;</span><br><span class="line">        return p;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[leetcode 1. Two Sum]]></title>
      <url>http://yoursite.com/2016/06/12/leetcode%201.%20Two%20Sum/</url>
      <content type="html"><![CDATA[<h3 id="写在前面的话"><a href="#写在前面的话" class="headerlink" title="写在前面的话"></a>写在前面的话</h3><p>开始做leetcode的算法题，初步预期3个月左右做完一遍，一周5天每天5道题，剩余两天整理和学习，语言均用java。<br>第一遍做，争取完全自己得出AC结果，不求耗时短，不参考别人的答案。<br>一个比较浩大的工程，一段艰辛也应该充满趣味的过程，加油！</p>
<h2 id=""><a href="#" class="headerlink" title=""></a><a id="more"></a></h2><ol>
<li>Two Sum<br>Easy</li>
</ol>
<p>Given an array of integers, return indices of the two numbers such that they add up to a specific target.</p>
<p>You may assume that each input would have exactly one solution.</p>
<p>Example:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Given nums = [2, 7, 11, 15], target = 9,</span><br><span class="line"></span><br><span class="line">Because nums[0] + nums[1] = 2 + 7 = 9,</span><br><span class="line">return [0, 1].</span><br></pre></td></tr></table></figure></p>
<p>题目分析：无</p>
<p>初步思路：无</p>
<p>思路改进：无</p>
<p>最终代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public class Solution &#123;</span><br><span class="line">    public int[] twoSum(int[] nums, int target) &#123;</span><br><span class="line">        int index_1 = 0;</span><br><span class="line">        int index_2 = 0;</span><br><span class="line">        for(int i = 0; i &lt; nums.length; i++) &#123;</span><br><span class="line">            for(int j = i + 1; j &lt; nums.length; j++) </span><br><span class="line">                if(nums[i] + nums[j] == target) &#123;</span><br><span class="line">                    index_1 = i;</span><br><span class="line">                    index_2 = j;</span><br><span class="line">                    break;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return new int[]&#123;index_1,index_2&#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[php session源码分析]]></title>
      <url>http://yoursite.com/2016/06/08/php-session%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/</url>
      <content type="html"><![CDATA[<p>在研究php session回收机制的时候，发现了一种奇怪的现象：假如服务器只有一个人访问（且此时垃圾回收概率设置为1），若此时session已经过期，那么再次访问时他的session仍然存在。看了一些资料，了解到session执行时，有以下几个步骤：<br><a id="more"></a><br><img src="http://o7bsrhxey.bkt.clouddn.com/QQ%E6%88%AA%E5%9B%BE20160606142537.jpg" alt="image">  </p>
<h2 id="本着严谨的态度，对php-src-version-7-中session-c进行了一些研究。"><a href="#本着严谨的态度，对php-src-version-7-中session-c进行了一些研究。" class="headerlink" title="本着严谨的态度，对php-src version 7 中session.c进行了一些研究。"></a>本着严谨的态度，对php-src version 7 中session.c进行了一些研究。</h2><h2 id="php源码从哪找？"><a href="#php源码从哪找？" class="headerlink" title="php源码从哪找？"></a>php源码从哪找？</h2><p>1、官网 <a href="http://windows.php.net/download/" target="_blank" rel="external">http://windows.php.net/download/</a><br><img src="http://o7bsrhxey.bkt.clouddn.com/QQ%E6%88%AA%E5%9B%BE20160607095502.jpg" alt="image"><br>2、php的github 账号 <a href="https://github.com/php/php-src" target="_blank" rel="external">https://github.com/php/php-src</a></p>
<p>另，官网有linux的包，但暂时linux还不太会用= =，之后再补上linux下看源码的方法。</p>
<h2 id="php源码目录结构"><a href="#php源码目录结构" class="headerlink" title="php源码目录结构"></a>php源码目录结构</h2><p>如图所示（php-src version 7）<br><img src="http://o7bsrhxey.bkt.clouddn.com/QQ%E6%88%AA%E5%9B%BE20160608135710.jpg" alt="image"><br>具体说明如下：</p>
<ol>
<li>build 和编译有关的目录。</li>
<li>ext 扩展库代码，例如 mysql、zlib、iconv、session（本次研究的session.c就在该目录下） 等扩展库。其中/ext/standard/ 目录下是常用的标准函数集。</li>
<li>main 主目录包含主要的 PHP 宏和定义。</li>
<li>对netware支持，Netware是NOVELL公司推出的网络操作系统。</li>
<li>pear 这个目录就是“PHP 扩展与应用仓库”的目录。包含了PEAR 的核心文件。</li>
<li>sapi 和各种服务器的接口调用，例如apache、IIS等，也包含一般的fastcgi、cgi等。<br>scripts Linux 下的脚本目录。</li>
<li>TSRM Zend 和 PHP 的 “线程安全资源管理器” (TSRM) 目录。</li>
<li>travis持续集成工具</li>
<li>tests 测试脚本目录</li>
<li>win32 和 Windows 下编译 PHP 有关的脚本。</li>
<li>Zend 文件夹核心的引擎，所有的 Zend API 定义与宏等。</li>
</ol>
<p>另：<br>php-src/main/php.h, 位于PHP主目录。这个文件包含了绝大部分 PHP 宏及 API 定义。<br>php-src/Zend/zend.h, 位于Zend 主目录。这个文件包含了绝大部分 Zend 宏及 API 定义。<br>php-src/Zend/zend_API.h, 也位于Zend 主目录，包含了Zend API 的定义</p>
<h2 id="php内核面向对象的类结构"><a href="#php内核面向对象的类结构" class="headerlink" title="php内核面向对象的类结构"></a>php内核面向对象的类结构</h2><p><img src="http://o7bsrhxey.bkt.clouddn.com/QQ%E6%88%AA%E5%9B%BE20160608142212.jpg" alt="image"><br><img src="http://o7bsrhxey.bkt.clouddn.com/QQ%E6%88%AA%E5%9B%BE20160608142652.jpg" alt="image"><br><img src="http://o7bsrhxey.bkt.clouddn.com/QQ%E6%88%AA%E5%9B%BE20160608142248.jpg" alt="image"></p>
<h2 id="session-c"><a href="#session-c" class="headerlink" title="session.c"></a>session.c</h2><p>查看源码可以发现，在php_session_initialize方法里调用了open、read、gc<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">static void php_session_initialize(void) /* &#123;&#123;&#123; */</span><br><span class="line">&#123;</span><br><span class="line">	zend_string *val = NULL;</span><br><span class="line"></span><br><span class="line">	PS(session_status) = php_session_active;</span><br><span class="line"></span><br><span class="line">	if (!PS(mod)) &#123;</span><br><span class="line">		PS(session_status) = php_session_disabled;</span><br><span class="line">		php_error_docref(NULL, E_ERROR, &quot;No storage module chosen - failed to initialize session&quot;);</span><br><span class="line">		return;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/* Open session handler first */</span><br><span class="line">	if (PS(mod)-&gt;s_open(&amp;PS(mod_data), PS(save_path), PS(session_name)) == FAILURE</span><br><span class="line">		/* || PS(mod_data) == NULL */ /* FIXME: open must set valid PS(mod_data) with success */</span><br><span class="line">	) &#123;</span><br><span class="line">		php_session_abort();</span><br><span class="line">		php_error_docref(NULL, E_ERROR, &quot;Failed to initialize storage module: %s (path: %s)&quot;, PS(mod)-&gt;s_name, PS(save_path));</span><br><span class="line">		return;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/* If there is no ID, use session module to create one */</span><br><span class="line">	if (!PS(id) || !ZSTR_VAL(PS(id))[0]) &#123;</span><br><span class="line">		if (PS(id)) &#123;</span><br><span class="line">			zend_string_release(PS(id));</span><br><span class="line">		&#125;</span><br><span class="line">		PS(id) = PS(mod)-&gt;s_create_sid(&amp;PS(mod_data));</span><br><span class="line">		if (!PS(id)) &#123;</span><br><span class="line">			php_session_abort();</span><br><span class="line">			php_error_docref(NULL, E_ERROR, &quot;Failed to create session ID: %s (path: %s)&quot;, PS(mod)-&gt;s_name, PS(save_path));</span><br><span class="line">			return;</span><br><span class="line">		&#125;</span><br><span class="line">		if (PS(use_cookies)) &#123;</span><br><span class="line">			PS(send_cookie) = 1;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; else if (PS(use_strict_mode) &amp;&amp; PS(mod)-&gt;s_validate_sid &amp;&amp;</span><br><span class="line">		PS(mod)-&gt;s_validate_sid(&amp;PS(mod_data), PS(id)) == FAILURE) &#123;</span><br><span class="line">		if (PS(id)) &#123;</span><br><span class="line">			zend_string_release(PS(id));</span><br><span class="line">		&#125;</span><br><span class="line">		PS(id) = PS(mod)-&gt;s_create_sid(&amp;PS(mod_data));</span><br><span class="line">		if (!PS(id)) &#123;</span><br><span class="line">			PS(id) = php_session_create_id(NULL);</span><br><span class="line">		&#125;</span><br><span class="line">		if (PS(use_cookies)) &#123;</span><br><span class="line">			PS(send_cookie) = 1;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	php_session_reset_id();</span><br><span class="line"></span><br><span class="line">	/* Read data */</span><br><span class="line">	php_session_track_init();</span><br><span class="line">	if (PS(mod)-&gt;s_read(&amp;PS(mod_data), PS(id), &amp;val, PS(gc_maxlifetime)) == FAILURE) &#123;</span><br><span class="line">		php_session_abort();</span><br><span class="line">		/* Some broken save handler implementation returns FAILURE for non-existent session ID */</span><br><span class="line">		/* It&apos;s better to raise error for this, but disabled error for better compatibility */</span><br><span class="line">		php_error_docref(NULL, E_WARNING, &quot;Failed to read session data: %s (path: %s)&quot;, PS(mod)-&gt;s_name, PS(save_path));</span><br><span class="line">		return;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/* GC must be done after read */</span><br><span class="line">	php_session_gc();</span><br><span class="line"></span><br><span class="line">	if (PS(session_vars)) &#123;</span><br><span class="line">		zend_string_release(PS(session_vars));</span><br><span class="line">		PS(session_vars) = NULL;</span><br><span class="line">	&#125;</span><br><span class="line">	if (val) &#123;</span><br><span class="line">		if (PS(lazy_write)) &#123;</span><br><span class="line">			PS(session_vars) = zend_string_copy(val);</span><br><span class="line">		&#125;</span><br><span class="line">		php_session_decode(val);</span><br><span class="line">		zend_string_release(val);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在php_session_save_current_state调用了write、close<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> void php_session_save_current_state(int write) <span class="comment">/* &#123;&#123;&#123; */</span></span><br><span class="line">&#123;</span><br><span class="line">	int ret = FAILURE;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (write) &#123;</span><br><span class="line">		IF_SESSION_VARS() &#123;</span><br><span class="line">			<span class="keyword">if</span> (PS(mod_data) || PS(mod_user_implemented)) &#123;</span><br><span class="line">				zend_string *val;</span><br><span class="line"></span><br><span class="line">				val = php_session_encode();</span><br><span class="line">				<span class="keyword">if</span> (val) &#123;</span><br><span class="line">					<span class="keyword">if</span> (PS(lazy_write) &amp;&amp; PS(session_vars)</span><br><span class="line">						&amp;&amp; PS(mod)-&gt;s_update_timestamp</span><br><span class="line">						&amp;&amp; PS(mod)-&gt;s_update_timestamp != php_session_update_timestamp</span><br><span class="line">						&amp;&amp; ZSTR_LEN(val) == ZSTR_LEN(PS(session_vars))</span><br><span class="line">						&amp;&amp; !memcmp(ZSTR_VAL(val), ZSTR_VAL(PS(session_vars)), ZSTR_LEN(val))</span><br><span class="line">					) &#123;</span><br><span class="line">						ret = PS(mod)-&gt;s_update_timestamp(&amp;PS(mod_data), PS(id), val, PS(gc_maxlifetime));</span><br><span class="line">					&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">						ret = PS(mod)-&gt;s_write(&amp;PS(mod_data), PS(id), val, PS(gc_maxlifetime));</span><br><span class="line">					&#125;</span><br><span class="line">					zend_string_release(val);</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					ret = PS(mod)-&gt;s_write(&amp;PS(mod_data), PS(id), ZSTR_EMPTY_ALLOC(), PS(gc_maxlifetime));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> ((ret == FAILURE) &amp;&amp; !EG(<span class="keyword">exception</span>)) &#123;</span><br><span class="line">				<span class="keyword">if</span> (!PS(mod_user_implemented)) &#123;</span><br><span class="line">					php_error_docref(<span class="keyword">NULL</span>, E_WARNING, <span class="string">"Failed to write session data (%s). Please "</span></span><br><span class="line">									 <span class="string">"verify that the current setting of session.save_path "</span></span><br><span class="line">									 <span class="string">"is correct (%s)"</span>,</span><br><span class="line">									 PS(mod)-&gt;s_name,</span><br><span class="line">									 PS(save_path));</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					php_error_docref(<span class="keyword">NULL</span>, E_WARNING, <span class="string">"Failed to write session data using user "</span></span><br><span class="line">									 <span class="string">"defined save handler. (session.save_path: %s)"</span>, PS(save_path));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (PS(mod_data) || PS(mod_user_implemented)) &#123;</span><br><span class="line">		PS(mod)-&gt;s_close(&amp;PS(mod_data));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过上面说的，我们可以知道session的回收机制，确实是<br><img src="http://o7bsrhxey.bkt.clouddn.com/QQ%E6%88%AA%E5%9B%BE20160606142537.jpg" alt="image">  </p>
<p>参考资料<br>1、php-zend引擎分析 <a href="http://rapheal.sinaapp.com/2013/11/14/php_zend_lex/" target="_blank" rel="external">原文链接</a><br>2、php内核探索：一次请求生命周期 <a href="http://www.nowamagic.net/librarys/veda/detail/1287" target="_blank" rel="external">原文链接</a><br>3、php内核面向对象总结 <a href="http://blog.jobbole.com/97790/" target="_blank" rel="external">原文链接</a><br>4、php内核探索之变量（5）- session的基本原理 <a href="http://blog.csdn.net/ohmygirl/article/details/43152683" target="_blank" rel="external">原文链接</a><br>5、深入理解php之源码目录结构 <a href="http://blog.csdn.net/ctowoo/article/details/4626188" target="_blank" rel="external">原文链接</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[php session回收机制]]></title>
      <url>http://yoursite.com/2016/06/06/php-session%E5%9B%9E%E6%94%B6%E6%9C%BA%E5%88%B6/</url>
      <content type="html"><![CDATA[<p>在上一篇文章中说明了要保持用户的登录状态，必须保证cookie和session均有效，而如果换一种角度，问题就变为如何在规定时间内使用户登录状态失效呢？我们先从下面的问题说起。<br>（注意，本篇基于php默认session机制，php.ini配置：session.save_handler = files，即使用服务器/tmp目录下的文件来保存session）。</p>
<h2 id=""><a href="#" class="headerlink" title=" "></a><a id="more"></a> </h2><blockquote>
<h3 id="如何设置一个严格30分钟过期的Session"><a href="#如何设置一个严格30分钟过期的Session" class="headerlink" title="如何设置一个严格30分钟过期的Session"></a><a href="http://www.laruence.com/2012/01/10/2469.html" target="_blank" rel="external">如何设置一个严格30分钟过期的Session</a></h3></blockquote>
<p>在该文章中，讨论了4种答案，其中前两种错误，后两种正确。</p>
<h5 id="答案1：session设置过期时间-session-gc-maxlifetime"><a href="#答案1：session设置过期时间-session-gc-maxlifetime" class="headerlink" title="答案1：session设置过期时间(session.gc_maxlifetime)"></a>答案1：session设置过期时间(session.gc_maxlifetime)</h5><p>错误原因：<br>1、session设置了过期时间，超过这个时间session并不一定立刻被销毁。<br>2、session是否过期，判断的是：session那个文件的最后修改时间 + 最大生存时间 与当前时间的关系，所以如果代码中对session有写入操作，则最后修改时间会一直增大，于是session一直不会过期。<br>3、在同一服务器上有多个项目，且存储session的目录均为/tmp，session有可能提前被销毁。</p>
<p>总结：session过期时间并不能保证，session在这个时间点之前一直存在，在这个时间点之后一定销毁。<br>1,3与session的回收机制有关，具体原因后面再说。<br>另外，关于过期时间这个词，似乎会有一些乱用的情况，准确的关系是，过期时间 = session文件最后修改时间 + session最大生存时间（session.gc_maxlifetime），然后判断的就是过期时间与当前时间的关系。</p>
<h5 id="答案2：cookie设置过期时间-session-cookie-lifetime"><a href="#答案2：cookie设置过期时间-session-cookie-lifetime" class="headerlink" title="答案2：cookie设置过期时间(session.cookie_lifetime)"></a>答案2：cookie设置过期时间(session.cookie_lifetime)</h5><p>错误原因：<br>1、cookie中保存的是sessionId,到了过期时间浏览器会自动删除sessionId的cookie，但可以将把sessionId从浏览器中粘贴出来，之后用Js设置cookie，cookie中就又有了sessionId。<br>2、以上的过程，举个例子（联系上一篇文章）就是你把会员卡号记录在一张特殊的纸上，这张纸上的字到期会自动消失，那么你只需要在字消失之前把字抄在另外一张普通的纸上，如果需要就从普通的纸上把字抄回特殊的纸上，就能保证会员卡号永远在特殊的纸上存在。<br>3、关键在于，cookie中有没有sessionId,不影响服务器上对应目录下session文件是否存在。只要session文件存在，并且你能记录sessionId，就能找到session。</p>
<h5 id="答案3：使用内存数据库redis、memcache"><a href="#答案3：使用内存数据库redis、memcache" class="headerlink" title="答案3：使用内存数据库redis、memcache"></a>答案3：使用内存数据库redis、memcache</h5><p>答案正确，但并不是仅依靠php本身。<br>这类数据库有自己的过期机制，到期会自动删除对应的文件，即保证在一个时间点前一直存在，在一个时间点后一定销毁。</p>
<h5 id="答案4：在session中保存一个登录时间的时间戳，每次读session时判断是否过期"><a href="#答案4：在session中保存一个登录时间的时间戳，每次读session时判断是否过期" class="headerlink" title="答案4：在session中保存一个登录时间的时间戳，每次读session时判断是否过期"></a>答案4：在session中保存一个登录时间的时间戳，每次读session时判断是否过期</h5><p>答案正确。<br>比如下面的代码，在$auth中保存了用户id和登录时间，之后读session时都判断登录时间 + 最大生存时间 与 当前时间的关系。如果小于，那么销毁session，如果大于，就正常处理请求。<br>登录时在session中保存登录时间戳：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">($username = null, $password = null, $verify = null)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(IS_POST)&#123;</span><br><span class="line">           <span class="keyword">if</span>(!check_verify($verify))&#123;</span><br><span class="line">              $this-&gt;error(<span class="string">'验证码错误！'</span>,<span class="string">'Index/login'</span>);</span><br><span class="line">           &#125;</span><br><span class="line">           $administrator = D(<span class="string">'Administrator'</span>);</span><br><span class="line">           $id = $administrator-&gt;login($username, $password);</span><br><span class="line">           <span class="keyword">if</span>(<span class="number">0</span> &lt; $id)&#123;</span><br><span class="line">               <span class="comment">/* 记录登录SESSION */</span></span><br><span class="line">               $auth = <span class="keyword">array</span>(</span><br><span class="line">                   <span class="string">'id'</span> =&gt; $id,</span><br><span class="line">                   <span class="string">'login_update_time'</span> =&gt; time(),</span><br><span class="line">               );</span><br><span class="line">               session(<span class="string">'administrator_auth'</span>, $auth);</span><br><span class="line">               session(<span class="string">'administrator_auth_sign'</span>,md5($auth[<span class="string">'id'</span>].$auth[<span class="string">'login_time'</span>]));</span><br><span class="line">               $this-&gt;success(<span class="string">'登录成功！'</span>, U(<span class="string">'index'</span>));</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123; <span class="comment">//登录失败</span></span><br><span class="line">               <span class="keyword">switch</span>($id) &#123;</span><br><span class="line">                   <span class="keyword">case</span> <span class="number">-1</span>:</span><br><span class="line">                       $error = <span class="string">'用户不存在或被禁用！'</span>;</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                   <span class="keyword">case</span> <span class="number">-2</span>:</span><br><span class="line">                       $error = <span class="string">'密码错误！'</span>;</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">                   <span class="keyword">default</span>:</span><br><span class="line">                       $error = <span class="string">'未知错误！'</span>;</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               $this-&gt;error($error,<span class="string">'Index/login'</span>);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">if</span>(is_login())&#123;</span><br><span class="line">               $this-&gt;redirect(<span class="string">'index'</span>);</span><br><span class="line">           &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">               $this-&gt;display();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>判断是否登录时，从session中取登录时间，判断登录时间 + 最大生存时间 与当前时间的关系：<br><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line"> * 检测用户是否登录</span><br><span class="line"> * <span class="doctag">@return</span> integer 0：未登录，大于0：当前登录用户ID</span><br><span class="line"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_login</span><span class="params">()</span></span>&#123;</span><br><span class="line">    $auth  = session(<span class="string">'administrator_auth'</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>($auth)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        $config = C(<span class="string">'SESSION_OPTIONS'</span>);</span><br><span class="line">        <span class="keyword">if</span>(session(<span class="string">'administrator_auth.login_time'</span>) + $config[<span class="string">'expire'</span>] &lt; time())&#123;</span><br><span class="line">            session(<span class="string">'[destroy]'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> session(<span class="string">'administrator_auth_sign'</span>) == md5($auth[<span class="string">'id'</span>].$auth[<span class="string">'login_time'</span>]) ? $auth[<span class="string">'id'</span>] : <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>另外，我认为原作者所说的，在第四种答案中要设置cookie和session过期时间都为30分钟，是没有必要的，因为只要服务器上不存在对应的session文件，即使cookie中保存了sessionId也是没有意义的。</p>
<hr>
<p>通过上面的问题，我们会发现，按照常理来讲最便捷、最容易想到的第一种方法不正确的原因在于php session的回收机制并不能保证session在过期前一定存在，过期后一定销毁，那么php对于session的回收机制到底是怎样的呢？</p>
<h3 id="session执行过程关键的5个步骤如下："><a href="#session执行过程关键的5个步骤如下：" class="headerlink" title="session执行过程关键的5个步骤如下："></a>session执行过程关键的5个步骤如下：</h3><p><img src="http://o7bsrhxey.bkt.clouddn.com/QQ%E6%88%AA%E5%9B%BE20160606142537.jpg" alt="image"></p>
<h5 id="1、open"><a href="#1、open" class="headerlink" title="1、open"></a>1、open</h5><p>开启对/tmp文件目录的管理</p>
<h5 id="2、read"><a href="#2、read" class="headerlink" title="2、read"></a>2、read</h5><p>从/tmp目录读session文件放到内存</p>
<h5 id="3、gc（garbage-collection）"><a href="#3、gc（garbage-collection）" class="headerlink" title="3、gc（garbage collection）"></a>3、gc（garbage collection）</h5><p>垃圾回收，将/tmp目录下过期的session文件删除，但gc并不是一定会进行垃圾回收，而是以一定的概率进行。<br>在php配置文件php.ini中，有以下两个参数：<br>session.gc_probability = 1<br>session.gc_divisor =1000<br>垃圾回收的概率是 session.gc_probability / session.gc_divisor 即 1/1000</p>
<h5 id="4、write"><a href="#4、write" class="headerlink" title="4、write"></a>4、write</h5><p>将内存中的session文件写回/tmp目录</p>
<h5 id="5、close"><a href="#5、close" class="headerlink" title="5、close"></a>5、close</h5><p>关闭对/tmp目录的管理</p>
<h5 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h5><p>在处理请求时，如果这个请求的处理中会操作session，则有一定概率进行垃圾回收，删除过期session。考虑一种极端情况，如果没有请求，那么这个session文件会一直存在。前面所说的，第一种答案不正确的原因便在此。</p>
<h3 id="再考虑另一种极端情况，假如服务器只有一个人访问（且此时垃圾回收概率设置为1），若此时session已经过期，那么再次访问时他的session会被删除吗？"><a href="#再考虑另一种极端情况，假如服务器只有一个人访问（且此时垃圾回收概率设置为1），若此时session已经过期，那么再次访问时他的session会被删除吗？" class="headerlink" title="再考虑另一种极端情况，假如服务器只有一个人访问（且此时垃圾回收概率设置为1），若此时session已经过期，那么再次访问时他的session会被删除吗？"></a>再考虑另一种极端情况，假如服务器只有一个人访问（且此时垃圾回收概率设置为1），若此时session已经过期，那么再次访问时他的session会被删除吗？</h3><p>走一遍上面所说的过程<br>open打开文件管理，read将session读入内存<br>gc进行垃圾回收，将这个过期的session删除<br>write将内存中的session写回，close关闭文件管理</p>
<p>可以发现，那个session文件在gc过程中被删除了，但是在write过程中又写回，从表面来看那个目录下的这个文件没有变化，但实际上这个session文件是先被删除之后再被写回的。<br>这里的写回动作，应该理解为文件复制，实际测试发现session文件的创建时间和修改时间没有变化。</p>
<p>可是，没有变化，那怎么知道是先删除再创建的？还有上面的那个session过程的5个步骤又是哪来的？</p>
<p>于是就有了下篇文章<a href="http://note.youdao.com/" target="_blank" rel="external">《php session源码分析》</a>，在这篇文章中将探讨以上问题。</p>
<p>参考资料<br>1、如何设置一个严格30分钟过期的Session <a href="http://www.laruence.com/2012/01/10/2469" target="_blank" rel="external">原文链接</a><br>2、session 入库的实现2  gc() —— 垃圾回收机制 <a href="http://blog.sina.com.cn/s/blog_9d7221820102vbe6.html" target="_blank" rel="external">原文链接</a><br>3、彻底理解PHP的SESSION机制 <a href="http://www.cnblogs.com/acpp/archive/2011/06/10/2077592.html" target="_blank" rel="external">原文链接</a><br>4、php-src version 7 session.c <a href="https://github.com/SagaciousHugo/php-src/blob/master/ext/session/session.c" target="_blank" rel="external">源码</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[php中的session和cookie]]></title>
      <url>http://yoursite.com/2016/05/17/php%E4%B8%AD%E7%9A%84session%E5%92%8Ccookie/</url>
      <content type="html"><![CDATA[<p>最近在项目中使用了thinkphp框架，对php中的session和cookie进行了一些研究。根据客户的需求，在文本编辑页面长时间无操作时，用户的登录状态应依然保持，即session和cookie均会自动延长其生存时间。</p>
<h2 id=""><a href="#" class="headerlink" title=" "></a><a id="more"></a> </h2><hr>
<h1 id="session和cookie的由来"><a href="#session和cookie的由来" class="headerlink" title="session和cookie的由来"></a>session和cookie的由来</h1><h3 id="http协议的无状态性"><a href="#http协议的无状态性" class="headerlink" title="http协议的无状态性"></a>http协议的无状态性</h3><p>http是一个无状态协议，每次的请求都是独立的，它的执行情况和结果与前面的请求和之后的请求是无直接关系的，它不会受前面的请求应答情况直接影响，也不会直接影响后面的请求应答情况。<br>http协议具有的这种特性，如果不加扩展改造，就不能满足web应用的需求。通常web应用都是有状态的，前后请求是需要有关联性，比如前一次请求是用户登录，那后一次请求是查看首页。若用户登录请求成功，那么查看首页应该成功；若用户登录请求失败，那么查看首页应该失败且返回登录页。<br>因此，为了使http协议也能够有状态，引入了session和cookie机制。<br>可做此理解，web应用的有状态性 = http的无状态性 + session、cookie状态机制</p>
<h3 id="引例"><a href="#引例" class="headerlink" title="引例"></a>引例</h3><p>将上面的问题转化为一个生活中超市购物的例子。<br>比如沃尔玛，每天有数以千计的人去进行购物，而你今天去购物，又或者明天去购物，这两次购物行为之间没有什么关系，可以认为是独立的，而且对于超市而言，并不知道这次是谁在购物，这样的一次购物行为就相当于一次http请求。而如果考虑用户购物积分机制，每次购物都会根据金额为该用户增加积分，这样为了证明是你在购物，所以超市会给你发一个凭证——会员卡。<br>于是在每次购物时，出示会员卡，就把这次购物变成了超市知道是某个会员在购物的购物行为。</p>
<p>对于这张会员卡应该有两层理解的含义：1、对于超市，数据库里有一张表，存着这个卡号以及用户的积分信息 2、对于用户，手里有一张卡，卡内有芯片记录着卡号 </p>
<p>把上述例子中超市变成服务器，购物的人变成客户端（这里的客户端即，浏览器），购物行为变成访问请求，就回到了web应用场景。<br>那么，用户手里的那张会员卡和超市数据库中存储卡号和用户积分的那条记录在web应用中又是什么呢？<br>答案就是：<br>session的作用就相当于上面所说超市数据库中存储卡号及用户信息的那条记录,sessionid即卡号。<br>cookie的作用就相当于用户手中记录卡号的会员卡。</p>
<h3 id="session"><a href="#session" class="headerlink" title="session"></a>session</h3><p>在php中，默认的session机制，是用磁盘文件实现，每一个session都是服务器tmp目录下的一个文件，<br>如图所示：<img src="http://o7bsrhxey.bkt.clouddn.com/QQ%E6%88%AA%E5%9B%BE20160601105934.jpg" alt="image"><br>在这个文件中通常保存一些用户相关的信息,在本项目中保存了用户id和登录时间，以及这两个参数进行md5加密以后的值，用于之后判断访问请求是否为登录状态。</p>
<pre><code>$auth = array(
    &apos;id&apos; =&gt; $id,
    &apos;login_time&apos; =&gt; time(),
);
session(&apos;administrator_auth&apos;, $auth);
session(&apos;administrator_auth_sign&apos;,md5($auth[&apos;id&apos;].$auth[&apos;login_time&apos;]));
</code></pre><p>当程序需要为某个客户端的请求创建一个session的时候，服务器首先检查这次请求里是否已包含了一个session标识，即sessionid,如果已包含一个sessionid，则从服务器上找到对应的session使用，否则就创建一个session并把sessionid返回给浏览器。</p>
<h3 id="cookie"><a href="#cookie" class="headerlink" title="cookie"></a>cookie</h3><p>cookie是储存在用户本地终端（浏览器）上的数据，服务器可以利用cookie包含的信息以判断在http传输中的状态。<br>服务器创建session后，会将sessionid返回给浏览器，浏览器会将sessionid存在cookie中，当再次请求时，浏览器会在请求中带上cookie中所保存的全部参数。<br>例如下面的过程：<br>第一次请求进入登录页面，cookie中没有sessionid，返回报文给cookie设置sessionid为s1vu7me3dt718g2fjlmuclk2i4<br><img src="http://o7bsrhxey.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720160601112535.png" alt="image"><br>此时服务器tmp目录下增加了文件名为sess_s1vu7me3dt718g2fjlmuclk2i4的文件，说明服务器为第一请求创建了对应的session<br><img src="http://o7bsrhxey.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720160601112734.png" alt="image"><br>第二次请求用户登录，可以看到请求报文中cookie中有sessionid=s1vu7me3dt718g2fjlmuclk2i4<img src="http://o7bsrhxey.bkt.clouddn.com/QQ%E5%9B%BE%E7%89%8720160601112847.png" alt="image"></p>
<h1 id="如何保持用户登录状态"><a href="#如何保持用户登录状态" class="headerlink" title="如何保持用户登录状态"></a>如何保持用户登录状态</h1><p>通过上面的说明，可以知道保持用户登录状态，即一次有状态的访问需要从cookie中得到sessionid，并且服务器tmp目录下有对应的session文件。即保持用户状态需要两个条件：1、cookie有效 2、session有效<br>这就引出了两个问题，cookie的生命周期和session的生命周期。</p>
<h3 id="cookie的生命周期"><a href="#cookie的生命周期" class="headerlink" title="cookie的生命周期"></a>cookie的生命周期</h3><p>cookie一般不是永久保存在浏览器，当到了过期时间时，cookie会被删除，过期时间一般有以下2种情况<br>1、浏览会话结束时<br>如果不进行设置，cookie默认浏览窗口关闭即失效</p>
<p>2、服务器返回报文set-cookie时，会设置cookie对应的过期时间，则cookie在该过期时间之前均有效</p>
<h3 id="session的生命周期"><a href="#session的生命周期" class="headerlink" title="session的生命周期"></a>session的生命周期</h3><p>服务器创建session时，会有session对应的失效时间，超过这个时间，服务器会删除tmp目录下对应的session文件。<br>//TODO session回收机制</p>
<h1 id="解决问题"><a href="#解决问题" class="headerlink" title="解决问题"></a>解决问题</h1><p>那么对于开头需求，在文本编辑页面长时间无操作时，用户的登录状态应依然保持，就需要在这个页面可以保持cookie和session均有效。  </p>
<h3 id="1、在对应页面script中使用setInterval方法每隔5分钟向后台发一次请求"><a href="#1、在对应页面script中使用setInterval方法每隔5分钟向后台发一次请求" class="headerlink" title="1、在对应页面script中使用setInterval方法每隔5分钟向后台发一次请求"></a>1、在对应页面script中使用setInterval方法每隔5分钟向后台发一次请求</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> setInterval(function ()&#123;</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        url: &quot;&#123;:U(&apos;sessionDelay&apos;)&#125;&quot;,</span><br><span class="line">        type: &quot;GET&quot;,</span><br><span class="line">        async: true,</span><br><span class="line">        data: &#123;&#125;,</span><br><span class="line">        dataType: &quot;json&quot;,</span><br><span class="line">        success: function(data)&#123;</span><br><span class="line">            if(data.status==&apos;success&apos;)&#123;</span><br><span class="line">                console.log(&quot;the user is editing.&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;,5*60*1000);</span><br></pre></td></tr></table></figure>
<h3 id="2、每次访问请求都更新cookie的过期时间"><a href="#2、每次访问请求都更新cookie的过期时间" class="headerlink" title="2、每次访问请求都更新cookie的过期时间"></a>2、每次访问请求都更新cookie的过期时间</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function __construct() &#123;</span><br><span class="line">        parent::__construct();</span><br><span class="line">        define(&apos;ID&apos;, is_login());</span><br><span class="line">        if (!ID) &#123;// 还没登录 跳转到登录页面</span><br><span class="line">            $this-&gt;redirect(&apos;Index/login&apos;);</span><br><span class="line">        &#125;</span><br><span class="line">        cookie(&apos;PHPSESSID&apos;, cookie(&apos;PHPSESSID&apos;), array(&apos;expire&apos;=&gt;24 * 3600, &apos;path&apos;=&gt;&quot;/&quot;));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h3 id="3、后台在判断是否登录时，根据需要延长session有效时间"><a href="#3、后台在判断是否登录时，根据需要延长session有效时间" class="headerlink" title="3、后台在判断是否登录时，根据需要延长session有效时间"></a>3、后台在判断是否登录时，根据需要延长session有效时间</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line"> * 检测用户是否登录</span><br><span class="line"> * @return integer 0：未登录，大于0：当前登录用户ID</span><br><span class="line"> */</span><br><span class="line">function is_login()&#123;</span><br><span class="line">    $auth  = session(&apos;administrator_auth&apos;);</span><br><span class="line">    if (empty($auth)) &#123;</span><br><span class="line">        session(&apos;login_update_time&apos;,time());</span><br><span class="line">        return 0;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        $config = C(&apos;SESSION_OPTIONS&apos;);</span><br><span class="line">        if(time() - session(&apos;login_update_time&apos;) &gt; $config[&apos;expire&apos;] / 2 )&#123;</span><br><span class="line">            session(&apos;login_update_time&apos;,time());</span><br><span class="line">        &#125;</span><br><span class="line">        return session(&apos;administrator_auth_sign&apos;) == md5($auth[&apos;id&apos;].$auth[&apos;login_time&apos;]) ? $auth[&apos;id&apos;] : 0;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过以上三点，实现了在编辑页面无限长时间无操作，仍然保持用户登录状态。</p>
<p>另，thinkphp框架中并没有对cookie进行有效时间设置，所以如果在代码中不显式的设置，那么cookie过期时间均为浏览会话结束时，这样的话即使session依然存在，本地却没有保存sessionid，就无法达到保持登录状态的需求。<br>在研究这个问题时，看到了一篇文章，如下<br><img src="http://o7bsrhxey.bkt.clouddn.com/QQ%E6%88%AA%E5%9B%BE20160601133111.jpg" alt="image"><br>这位博主错误理解了session和cookie，因为没有显式设置cookie过期时间导致无法保持登录状态，却理解为session失效，以及thinkphp框架有bug，并改了框架源码= =。<br><a href="http://baijunyao.com/article/50" target="_blank" rel="external">原文链接</a></p>
]]></content>
    </entry>
    
    <entry>
      <title><![CDATA[Hello World]]></title>
      <url>http://yoursite.com/2016/05/16/hello-world/</url>
      <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>
]]></content>
    </entry>
    
  
  
</search>
